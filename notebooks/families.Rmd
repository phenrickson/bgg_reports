---
title: "Examining BGG Families"
author: Phil Henrickson
params:
        train_year: 2020
        min_ratings: 50
---

```{r setup, inclue=F, results = 'hide', message=F, warning=F}

source(here::here("src", "helpers", "exploratory_setup.R"))

```

```{r load functions for categorical, include=F} 

source(here::here("src", "functions", "categorical_functions.R"))

```


```{r create tidy games, include=F}

# set minimum ratings
min_ratings = params$min_ratings

# train year
train_year = params$train_year

# remove unreleased and problem games
tidy_games =
        analysis_games %>%
        # remove unreleased and problem games
        filter(!(game_id %in% c(
                unreleased_games$game_id,
                drop_games$game_id))
        ) %>%
        # filter out games with missingness on yearpublished
        filter(!is.na(yearpublished)) %>%
        # filter out games with missingness on average weight
        filter(!is.na(averageweight) & averageweight!=0) %>%
        # filter our kickstarter editions and big box editions
      #  filter(!(grepl("kickstarter|big box|mega box|megabox", tolower(name)))) %>%
        # filter to games released prior to current year
        filter(yearpublished < year(Sys.Date())) %>%
        # filter to games with at least X votes
        filter(usersrated >= min_ratings) %>%
        # set yearpublished to numeric
        mutate(yearpublished = as.numeric(yearpublished))

```

```{r functions and captions}

# caption
my_caption = 
        list(labs(caption = paste(paste("data from boardgamegeek.com as of", max(as.Date(tidy_games$load_ts))),
                                  #    paste("analysis by phil henrickson"),
                                  paste("phenrickson.github.io/data-analysis-paralysis/boardgames.html"), sep="\n")))

```

This notebook provides some basic exploratory analysis of games on boardgamegeek (BGG) in support of my work [predicting ratings for upcoming games] and [predicting games for individual users]. 

For this write up, I examine games published through `r train_year` that have achieved at least `r min_ratings` user ratings by the time of writing.[^ I have additionally excluded some games that were cancelled or never released, or have data quality issues with their profiles on BGG.]

What are the families of games on BGG and how do they relate to community ratings?

# Families

## Most Frequent

What are the most frequent families on BGG?

```{r most common families, warning=F, message=F}

game_families %>%
        mutate(value = family_value) %>%
        group_by(type, id, value) %>%
        summarize(games = n_distinct(game_id),
                  .groups = 'drop') %>%
        slice_max(games, n = 50, with_ties=F) %>%
        arrange(desc(games)) %>%
        mutate(rank = row_number()) %>%
        mutate(page = case_when(rank %in% seq(1, 25) ~ "1-25",
                                rank %in% seq(26, 50) ~ "26-50")) %>%
        mutate(value = abbreviate(value, minlength=25)) %>%
        ggplot(aes(y=reorder(value,games),
                   x=games))+
        geom_col()+
        theme_phil()+
        theme(axis.text.y = element_text(size = 8),
              strip.text.x = element_text(size = 6))+
        facet_wrap(. ~ page,
                   scales = "free_y")+
        scale_x_continuous(breaks = scales::pretty_breaks(n=3))+
        ylab("Family")+
        xlab("Number of Games")
        

```

For BGG *family* variables, we can consider the hierarchy 

```{r top within each family}

game_families %>%
        filter(family_type %in%
                       c('Series',
                         'Theme',
                         'Country',
                         'Mechanism',
                         'Category',
                         'Components',
                         'Animals',
                         'Game',
                         'Sports')) %>%
        group_by(family_type, id, family_value) %>%
        summarize(games = n_distinct(game_id),
                  .groups = 'drop') %>%
        group_by(family_type) %>%
        slice_max(games, n = 5, with_ties=F) %>%
        ungroup() %>%
        mutate(family_value = abbreviate(family_value, minlength=25)) %>%
        ggplot(aes(y=tidytext::reorder_within(family_value, games, family_type),
                   x=games))+
        geom_col()+
        theme_phil()+
        theme(axis.text.y = element_text(size = 8),
              strip.text.x = element_text(size = 6))+
        facet_wrap(family_type ~.,
                   scales = "free")+
        ylab("Family")+
        xlab("Number of Games")+
        scale_y_reordered()+
        scale_x_continuous(breaks = scales::pretty_breaks(n=3))

```


## Families by BGG Outcome

How are games within each family typically rated?

I'll then plot the distribution of games with the 25 most frequent families. What types of families are typically associated with heavier games? What family is the highest rated (on average)?

```{r plot families}

plot_games_by_categorical(game_families,
                             25)

```

Finally, the following (interactive) table displays the mean of each BGG outcome by family. Use the filters below the column names to filter through the table by family or number of games. 

```{r make summary table}

# summarize data
summary_data = game_families %>%
        summarize_games_by_categorical()


# color gradients
colorRampDiv = colorRampPalette(c("red", "white", "lightskyblue1"))
blueRampSeq = colorRampPalette(c("white", "skyblue1"))
redRampSeq = colorRampPalette(c("white", "orange"))

# generate table
summary_data %>%
        make_categorical_summary_table()

```

## Combinations of Families
 
What are the most frequent pairings of families in games on BGG? The following visualization displays an upset plot of the most frequent combinations of families used in games.

```{r upset plot}

upset = game_families %>%
        filter(game_id %in% tidy_games$game_id) %>%
        select(type, value, game_id) %>%
        mutate(has_type = 1) %>%
        pivot_wider(names_from = value, 
                    values_from = has_type,
                    values_fill = list(has_type = 0)) %>%
        as.data.frame() %>%
        UpSetR::upset(nsets = 15,
                      keep.order = T,
                      order.by = c("freq"),
                      mb.ratio = c(0.4, 0.6))

```

The bar chart on the bottom left indicates the number of games in each family. The bar chart on the top indicates the number of games with a **combination** of families. 

```{r print upset, fig.height = 8, out.width='100%'}

print(suppressMessages({
        upset
}))

```


